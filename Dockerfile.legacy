# ============================================
# MalgnLMS Legacy - Dockerfile
# ============================================
# Java 8 + JSP + Malgnsoft Framework
# Servlet Container: Apache Tomcat 9
# ============================================

# ============================================
# Stage 1: Build - Compile Java Sources
# ============================================
FROM maven:3.8-openjdk-8 AS build

WORKDIR /build

# Download Java EE APIs (required for compilation)
RUN curl -o servlet-api.jar \
    https://repo1.maven.org/maven2/javax/servlet/javax.servlet-api/3.1.0/javax.servlet-api-3.1.0.jar && \
    curl -o jsp-api.jar \
    https://repo1.maven.org/maven2/javax/servlet/jsp/jsp-api/2.2/jsp-api-2.2.jar && \
    curl -o mail-api.jar \
    https://repo1.maven.org/maven2/javax/mail/mail/1.4.7/mail-1.4.7.jar

# Copy WEB-INF libraries (including malgn-1.13.0.jar)
COPY public_html/WEB-INF/lib ./lib

# Copy Java source files
COPY src ./src

# Create output directory for compiled classes
RUN mkdir -p classes

# Compile only DAO sources (malgnsoft classes are in malgn-1.13.0.jar)
# Compile with relaxed error checking to handle missing dependencies
RUN javac -encoding UTF-8 \
    -cp "servlet-api.jar:jsp-api.jar:mail-api.jar:lib/*" \
    -d classes \
    -Xlint:none \
    $(find src/dao -name "*.java") 2>&1 | tee compile.log || true

# Check if any classes were compiled
RUN if [ "$(find classes -name '*.class' 2>/dev/null | wc -l)" -gt 0 ]; then \
        echo "Successfully compiled $(find classes -name '*.class' | wc -l) class files"; \
    else \
        echo "WARNING: No class files generated. Legacy may not work properly."; \
    fi

# ============================================
# Stage 2: Runtime - Tomcat Server
# ============================================
FROM tomcat:9-jdk8-openjdk-slim

# Remove default Tomcat webapps
RUN rm -rf /usr/local/tomcat/webapps/*

# Create ROOT webapp directory
RUN mkdir -p /usr/local/tomcat/webapps/ROOT

# Copy web resources from public_html
COPY public_html /usr/local/tomcat/webapps/ROOT/

# Copy compiled classes from build stage
COPY --from=build /build/classes /usr/local/tomcat/webapps/ROOT/WEB-INF/classes/

# Set environment variables
ENV CATALINA_OPTS="-Dfile.encoding=UTF-8 -Xms512m -Xmx1024m"
ENV JAVA_OPTS="-Djava.awt.headless=true -Djava.security.egd=file:/dev/./urandom"

# Expose port 8080 (Cloud Run requirement)
EXPOSE 8080

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8080/ || exit 1

# Start Tomcat
CMD ["catalina.sh", "run"]
