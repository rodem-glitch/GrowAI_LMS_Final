<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>KOSIS 인구 통계 데모</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body class="bg-light">
<main class="container py-4">
  <div class="mb-4">
    <h1 class="h3 fw-bold">KOSIS 인구 통계 조회</h1>
    <div class="text-secondary">`/statistics/kosis/population` API를 호출해서 간단히 시각화합니다.</div>
  </div>

  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <form id="searchForm" class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label" for="year">년도</label>
          <input id="year" class="form-control" inputmode="numeric" value="2024" />
        </div>
        <div class="col-md-5">
          <label class="form-label" for="ageType">연령대 코드(ageType)</label>
          <select id="ageType" class="form-select">
            <option value="30">10대 이하</option>
            <option value="31">10대</option>
            <option value="32" selected>20대</option>
            <option value="33">30대</option>
            <option value="34">40대</option>
            <option value="35">50대</option>
            <option value="36">60대</option>
            <option value="37">70대</option>
            <option value="38">80대</option>
            <option value="39">90대</option>
            <option value="40">70대 이상</option>
            <option value="41">80대 이상</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label" for="gender">성별(gender)</label>
          <select id="gender" class="form-select">
            <option value="0" selected>전체</option>
            <option value="1">남자</option>
            <option value="2">여자</option>
          </select>
        </div>
        <div class="col-md-2 d-grid">
          <button class="btn btn-primary" type="submit">조회</button>
        </div>
      </form>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <div id="status" class="small text-secondary mb-2"></div>
      <div style="height: 520px;">
        <canvas id="chart"></canvas>
      </div>
    </div>
  </div>
</main>

<script>
  let chartInstance = null;

  function setStatus(text) {
    document.getElementById("status").textContent = text || "";
  }

  function buildQuery() {
    const year = document.getElementById("year").value.trim();
    const ageType = document.getElementById("ageType").value;
    const gender = document.getElementById("gender").value;
    const params = new URLSearchParams({ year, ageType, gender });
    return params.toString();
  }

  function renderChart(labels, values) {
    const ctx = document.getElementById("chart").getContext("2d");

    if (!chartInstance) {
      chartInstance = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "인구 수",
            data: values,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: (v) => Number(v).toLocaleString()
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: (ctx) => ` ${Number(ctx.parsed.y).toLocaleString()}명`
              }
            }
          }
        }
      });
      return;
    }

    chartInstance.data.labels = labels;
    chartInstance.data.datasets[0].data = values;
    chartInstance.update();
  }

  async function fetchPopulation() {
    const query = buildQuery();
    setStatus("조회 중...");

    const response = await fetch(`/statistics/kosis/population?${query}`);
    const data = await response.json();

    if (!response.ok) {
      setStatus(`에러: ${data?.message || "요청 실패"}`);
      renderChart([], []);
      return;
    }

    if (!Array.isArray(data) || data.length === 0) {
      setStatus("결과가 없습니다.");
      renderChart([], []);
      return;
    }

    setStatus(`총 ${data.length}개 지역`);
    const labels = data.map((r) => r.admNm ?? "");
    const values = data.map((r) => Number(r.population ?? 0));
    renderChart(labels, values);
  }

  document.getElementById("searchForm").addEventListener("submit", (e) => {
    e.preventDefault();
    fetchPopulation();
  });

  fetchPopulation();
</script>
</body>
</html>
