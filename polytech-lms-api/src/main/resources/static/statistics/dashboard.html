<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>통계 대시보드</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body class="bg-light">
<main class="container py-4">
  <div class="mb-3">
    <h1 class="h3 fw-bold mb-1">통계 대시보드</h1>
    <div class="text-secondary small">
      정적 HTML 화면이며, 데이터는 `/statistics/api/*`에서 받아서 렌더링합니다.
    </div>
  </div>

  <ul class="nav nav-tabs mb-3" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="tab-internal" data-bs-toggle="tab" data-bs-target="#pane-internal" type="button" role="tab">
        입학 양성 취업 통계
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-population" data-bs-toggle="tab" data-bs-target="#pane-population" type="button" role="tab">
        인구별 통계
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-industry" data-bs-toggle="tab" data-bs-target="#pane-industry" type="button" role="tab">
        산업별 통계
      </button>
    </li>
  </ul>

  <div class="tab-content">
    <div class="tab-pane fade show active" id="pane-internal" role="tabpanel" aria-labelledby="tab-internal">
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between gap-3 flex-wrap">
            <div>
              <div class="fw-semibold">입학 양성 취업 통계</div>
              <div class="text-secondary small">내부(입시/졸업/취업) 통계는 엑셀/DB 원천을 확정한 뒤 단계적으로 고도화합니다.</div>
            </div>
            <div class="d-flex gap-2 flex-wrap">
              <select id="internalCampus" class="form-select form-select-sm" style="min-width: 180px;"></select>
            </div>
          </div>

          <div class="mt-3 p-3 border rounded bg-white d-flex align-items-center justify-content-between">
            <div>
              <div class="fw-semibold">입학 양성 취업 통합 데이터</div>
              <div class="text-secondary small">입학, 양성, 취업 관련 모든 상세 데이터를 필터/캠퍼스/연도로 조회하고 다운로드할 수 있습니다.</div>
            </div>
            <button id="downloadInternalCsv" class="btn btn-primary btn-sm" type="button">전체 데이터 다운로드</button>
          </div>

          <div id="internalStatus" class="text-secondary small mt-3"></div>

          <div class="fw-semibold mt-4">학과별 취업률</div>
          <div class="mt-3" style="height: 280px;">
            <canvas id="internalEmploymentChart"></canvas>
          </div>

          <div class="fw-semibold mt-4">학과별 입학충원률</div>
          <div class="mt-3" style="height: 280px;">
            <canvas id="internalAdmissionChart"></canvas>
          </div>

          <div class="fw-semibold mt-4">연도별 취업률 추이</div>
          <div class="mt-3" style="height: 260px;">
            <canvas id="internalTrendChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="pane-population" role="tabpanel" aria-labelledby="tab-population">
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between gap-3 flex-wrap">
            <div>
              <div class="fw-semibold">인구별 통계</div>
              <div class="text-secondary small">행정구역 인구 분포와 캠퍼스 학생 분포(가능한 경우)를 같은 기준으로 비교합니다.</div>
            </div>
            <div class="d-flex gap-2 flex-wrap">
              <select id="populationCampus" class="form-select form-select-sm" style="min-width: 180px;"></select>
              <select id="populationAdmCd" class="form-select form-select-sm" style="min-width: 180px;">
                <option value="11" selected>서울특별시</option>
                <option value="26">부산광역시</option>
                <option value="27">대구광역시</option>
                <option value="28">인천광역시</option>
                <option value="29">광주광역시</option>
                <option value="30">대전광역시</option>
                <option value="31">울산광역시</option>
                <option value="41">경기도</option>
                <option value="42">강원도</option>
                <option value="43">충청북도</option>
                <option value="44">충청남도</option>
                <option value="45">전라북도</option>
                <option value="46">전라남도</option>
                <option value="47">경상북도</option>
                <option value="48">경상남도</option>
                <option value="50">제주특별자치도</option>
              </select>
              <select id="populationYear" class="form-select form-select-sm" style="min-width: 110px;"></select>
            </div>
          </div>

          <div class="mt-3 p-3 border rounded bg-white d-flex align-items-center justify-content-between">
            <div>
              <div class="fw-semibold">지역 인구 통합 데이터</div>
              <div class="text-secondary small">현재 선택한 조건(캠퍼스/학기/행정구역/연도)으로 인구 비교 데이터를 엑셀로 다운로드합니다.</div>
            </div>
            <button id="downloadPopulationCsvTop" class="btn btn-primary btn-sm" type="button">엑셀 다운로드</button>
          </div>

          <div id="populationStatus" class="text-secondary small mt-3"></div>
        </div>
      </div>

      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div class="fw-semibold">연령대별 행정구역 인구비율 vs 캠퍼스 학생비율</div>
            <button id="downloadPopulationCsv" class="btn btn-outline-success btn-sm" type="button">엑셀 다운로드</button>
          </div>
          <div class="mt-3" style="height: 320px;">
            <canvas id="populationChart"></canvas>
          </div>

          <div class="fw-semibold mt-4">연령대별 캠퍼스-행정구역 비율 GAP</div>
          <div class="mt-3" style="height: 260px;">
            <canvas id="populationGapChart"></canvas>
          </div>

          <div class="fw-semibold mt-4">연령대별 남녀 성비: 행정구역 vs 캠퍼스</div>
          <div class="mt-3" style="height: 320px;">
            <canvas id="populationGenderChart"></canvas>
          </div>

          <div class="fw-semibold mt-4">연령대별 남녀 성비 GAP(캠퍼스-행정구역)</div>
          <div class="mt-3" style="height: 260px;">
            <canvas id="populationGenderGapChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="pane-industry" role="tabpanel" aria-labelledby="tab-industry">
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between gap-3 flex-wrap">
            <div>
              <div class="fw-semibold">산업별 통계</div>
              <div class="text-secondary small">지역 산업 비율(종사자)과 캠퍼스 학생 비율을 같은 분류(7개)로 비교합니다.</div>
            </div>
            <div class="d-flex gap-2 flex-wrap">
              <select id="industryCampus" class="form-select form-select-sm" style="min-width: 180px;"></select>
              <select id="industryAdmCd" class="form-select form-select-sm" style="min-width: 180px;">
                <option value="11" selected>서울특별시</option>
                <option value="26">부산광역시</option>
                <option value="27">대구광역시</option>
                <option value="28">인천광역시</option>
                <option value="29">광주광역시</option>
                <option value="30">대전광역시</option>
                <option value="31">울산광역시</option>
                <option value="36">세종특별자치시</option>
                <option value="41">경기도</option>
                <option value="42">강원특별자치도</option>
                <option value="43">충청북도</option>
                <option value="44">충청남도</option>
                <option value="45">전라북도</option>
                <option value="46">전라남도</option>
                <option value="47">경상북도</option>
                <option value="48">경상남도</option>
                <option value="50">제주특별자치도</option>
              </select>
              <select id="industryYear" class="form-select form-select-sm" style="min-width: 110px;"></select>
            </div>
          </div>

          <div class="mt-3 p-3 border rounded bg-white d-flex align-items-center justify-content-between">
            <div>
              <div class="fw-semibold">산업분포 통합 데이터</div>
              <div class="text-secondary small">현재 선택한 조건(캠퍼스/학기/행정구역/연도)으로 산업 비교 데이터를 엑셀로 다운로드합니다.</div>
            </div>
            <button id="downloadIndustryCsvTop" class="btn btn-primary btn-sm" type="button">엑셀 다운로드</button>
          </div>

          <div id="industryStatus" class="text-secondary small mt-3"></div>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div class="fw-semibold">산업분포 분석</div>
            <button id="downloadIndustryCsv" class="btn btn-outline-success btn-sm" type="button">엑셀 다운로드</button>
          </div>

          <div class="table-responsive mt-3">
            <table class="table table-sm table-bordered align-middle text-center">
              <thead class="table-secondary">
              <tr>
                <th style="min-width: 160px;">분야</th>
                <th>행정구역 종사자 비율</th>
                <th>캠퍼스 학생 비율</th>
                <th>GAP(캠퍼스-행정, %p)</th>
              </tr>
              </thead>
              <tbody id="industryTableBody"></tbody>
            </table>
          </div>

          <div class="fw-semibold mt-4">기술업종별 종사자 비율 vs 캠퍼스 학생 비율</div>
          <div class="mt-3" style="height: 320px;">
            <canvas id="industryChart"></canvas>
          </div>

          <div class="fw-semibold mt-4">기술업종별 종사자 캠퍼스-행정구역 비율 GAP</div>
          <div class="mt-3" style="height: 260px;">
            <canvas id="industryGapChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  let populationChartInstance = null;
  let populationGapChartInstance = null;
  let populationGenderChartInstance = null;
  let populationGenderGapChartInstance = null;
  let industryChartInstance = null;
  let industryGapChartInstance = null;
  let internalEmploymentChartInstance = null;
  let internalAdmissionChartInstance = null;
  let internalTrendChartInstance = null;

  function setPopulationStatus(text) {
    document.getElementById("populationStatus").textContent = text || "";
  }

  function setIndustryStatus(text) {
    document.getElementById("industryStatus").textContent = text || "";
  }

  function setInternalStatus(text) {
    document.getElementById("internalStatus").textContent = text || "";
  }

  function buildYearOptions(selectId) {
    const select = document.getElementById(selectId);
    select.innerHTML = "";
    const now = new Date().getFullYear();
    for (let y = now - 1; y >= now - 8; y--) {
      const opt = document.createElement("option");
      opt.value = String(y);
      opt.textContent = String(y);
      if (y === now - 1) opt.selected = true;
      select.appendChild(opt);
    }
  }

  function downloadCsv(filename, rows) {
    const lines = rows.map((row) => row.map((v) => `"${String(v ?? "").replaceAll('"', '""')}"`).join(","));
    const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function buildDeptRateMap(rows) {
    const map = new Map();
    (rows || []).forEach((r) => {
      if (!r?.dept) return;
      map.set(r.dept, Number(r.rate || 0));
    });
    return map;
  }

  function buildInternalDownloadRows(employmentRows, admissionRows) {
    // 왜: 취업/입학 데이터는 원천이 달라서 학과 목록이 1:1로 맞지 않을 수 있습니다.
    //     다운로드에서는 "학과명"을 키로 합쳐서 한 파일로 제공하는 편이 사용자 입장에서 편합니다.
    const employmentMap = buildDeptRateMap(employmentRows);
    const admissionMap = buildDeptRateMap(admissionRows);
    const deptSet = new Set([...employmentMap.keys(), ...admissionMap.keys()]);
    const depts = Array.from(deptSet).sort();

    return depts.map((dept) => [
      dept,
      employmentMap.has(dept) ? employmentMap.get(dept) : "",
      admissionMap.has(dept) ? admissionMap.get(dept) : ""
    ]);
  }

  async function loadMeta() {
    const groupsRes = await fetch("/statistics/api/meta/campus-groups");

    const campusGroups = await groupsRes.json();

    // 왜: 통계 기준이 "내부 DB 학기"가 아니라 "엑셀/통계청 API"이므로, 화면에서 학기(OPEN_TERM)를 노출하지 않습니다.
    //     탭이 3개(내부/인구/산업)라서, 캠퍼스 선택 박스는 각각 따로 둡니다.
    const campusSelects = ["populationCampus", "industryCampus", "internalCampus"].map((id) => document.getElementById(id));
    campusSelects.forEach((select) => {
      select.innerHTML = "";
      const allOpt = document.createElement("option");
      allOpt.value = "";
      allOpt.textContent = "전체 캠퍼스";
      select.appendChild(allOpt);

      (campusGroups || []).forEach((g) => {
        const optGroup = document.createElement("optgroup");
        optGroup.label = g.name || g.code || "";
        (g.campuses || []).forEach((c) => {
          const opt = document.createElement("option");
          opt.value = c;
          opt.textContent = c;
          optGroup.appendChild(opt);
        });
        select.appendChild(optGroup);
      });

      // 기본값: 첫 캠퍼스(있으면)
      const firstCampus = campusGroups?.[0]?.campuses?.[0];
      if (firstCampus) {
        select.value = firstCampus;
      }
    });
  }

  function termCodeToKoreanLabel(term) {
    // 왜: OPEN_TERM 값(예: 10, 11, 20, 30)은 통계청(KOSIS) 코드가 아니라 "내부 학사(미러) 학기 코드"라서,
    //     숫자만 보여주면 사용자가 의미를 알 수 없습니다. 화면에서는 최대한 한글 라벨로 풀어서 보여줍니다.
    const t = String(term || "").trim().toUpperCase();

    const baseMap = {
      "1": "1학기",
      "2": "2학기",
      "S": "여름학기",
      "W": "겨울학기"
    };
    if (baseMap[t]) return baseMap[t];

    if (/^\d+$/.test(t)) {
      // 왜: 폴리텍 학사 연동 데이터는 환경에 따라 1/2/S/W 대신 10/11/20/21/30 같은 코드로 들어오는 경우가 있어,
      //     가장 보수적으로 "앞자리(1/2/3)" 기준으로 학기를 추정하고, 실제 코드는 괄호로 병기합니다.
      if (t.startsWith("1")) return "1학기";
      if (t.startsWith("2")) return "2학기";
      if (t.startsWith("3")) return "계절학기";
    }

    return `학기코드(${t})`;
  }

  function formatYearTermLabel(year, term) {
    const label = termCodeToKoreanLabel(term);
    // 왜: 화면/다운로드 등에서 같은 코드가 반복되므로, 사용자가 나중에 추적할 수 있게 코드도 같이 보여줍니다.
    if (label.startsWith("학기코드")) {
      return `${year}년 ${label}`;
    }
    return `${year}년 ${label} (코드:${term})`;
  }

  function getSelectedOptionText(selectId) {
    const el = document.getElementById(selectId);
    return el?.selectedOptions?.[0]?.textContent || "";
  }

  function renderBarChart(canvasId, labels, datasets) {
    const ctx = document.getElementById(canvasId).getContext("2d");
    return new Chart(ctx, {
      type: "bar",
      data: { labels, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            ticks: { callback: (v) => `${Number(v).toFixed(0)}` }
          }
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: (ctx) => ` ${ctx.dataset.label}: ${Number(ctx.parsed.y).toFixed(2)}%`
            }
          }
        }
      }
    });
  }

  function renderStackedPercentChart(canvasId, labels, datasets) {
    // 왜: "남녀 성비"는 (남+여=100%) 형태가 직관적이라서, 스택 바 차트로 표시합니다.
    const ctx = document.getElementById(canvasId).getContext("2d");
    return new Chart(ctx, {
      type: "bar",
      data: { labels, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { stacked: true },
          y: {
            stacked: true,
            beginAtZero: true,
            max: 100,
            ticks: { callback: (v) => `${Number(v).toFixed(0)}` }
          }
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: (ctx) => ` ${ctx.dataset.label}: ${Number(ctx.parsed.y).toFixed(2)}%`
            }
          }
        }
      }
    });
  }

  function updateChart(instance, labels, datasets) {
    instance.data.labels = labels;
    instance.data.datasets = datasets;
    instance.update();
  }

  async function refreshInternal() {
    const campus = document.getElementById("internalCampus").value;

    if (!campus) {
      setInternalStatus("캠퍼스를 선택해 주세요.");
      return;
    }

    setInternalStatus("조회 중...");

    let employmentRes, admissionRes;
    try {
      [employmentRes, admissionRes] = await Promise.all([
        fetch(`/statistics/api/internal/employment/top?campus=${encodeURIComponent(campus)}&top=10`),
        fetch(`/statistics/api/internal/admission/top?campus=${encodeURIComponent(campus)}&top=10`)
      ]);
    } catch (e) {
      setInternalStatus(`내부 통계 요청 실패: ${e?.message || "요청 실패"}`);
      return;
    }

    let employmentData, admissionData;
    try {
      employmentData = await employmentRes.json();
    } catch (e) {
      setInternalStatus("취업률 응답을 해석하지 못했습니다. (서버 응답 형식 확인 필요)");
      return;
    }
    try {
      admissionData = await admissionRes.json();
    } catch (e) {
      setInternalStatus("입학충원률 응답을 해석하지 못했습니다. (서버 응답 형식 확인 필요)");
      return;
    }

    if (!employmentRes.ok) {
      setInternalStatus(`취업률 에러: ${employmentData?.message || "요청 실패"}`);
      return;
    }
    if (!admissionRes.ok) {
      setInternalStatus(`입학충원률 에러: ${admissionData?.message || "요청 실패"}`);
      return;
    }

    // 왜: 내부 통계는 "학기(내부 DB)" 기준이 아니라, 현재 엑셀 집계 데이터를 기준으로 표시합니다.
    setInternalStatus(`캠퍼스=${campus} / 기준=엑셀 집계`);

    document.getElementById("downloadInternalCsv").onclick = () => {
      // 왜: 브라우저에서 CSV를 만들면 한글/인코딩 이슈가 생길 수 있어, 서버에서 xlsx로 내려줍니다.
      window.location.href = `/statistics/api/internal/export?campus=${encodeURIComponent(campus)}`;
    };

    const empLabels = (employmentData || []).map((r) => r.dept);
    const empRates = (employmentData || []).map((r) => Number(r.rate || 0));

    const empDatasets = [
      { label: "취업률(%)", data: empRates, backgroundColor: "rgba(255, 193, 7, 0.85)" }
    ];

    if (!internalEmploymentChartInstance) {
      internalEmploymentChartInstance = renderBarChart("internalEmploymentChart", empLabels, empDatasets);
    } else {
      updateChart(internalEmploymentChartInstance, empLabels, empDatasets);
    }

    const admLabels = (admissionData || []).map((r) => r.dept);
    const admRates = (admissionData || []).map((r) => Number(r.rate || 0));

    const admDatasets = [
      { label: "입학충원률(%)", data: admRates, backgroundColor: "rgba(255, 193, 7, 0.85)" }
    ];

    if (!internalAdmissionChartInstance) {
      internalAdmissionChartInstance = renderBarChart("internalAdmissionChart", admLabels, admDatasets);
    } else {
      updateChart(internalAdmissionChartInstance, admLabels, admDatasets);
    }

    // 왜: 연도별 추이는 내부 원천이 확정되면 교체될 수 있어, 현재는 "현재 평균값"을 기준으로 간단히 표시합니다.
    const avg = empRates.length ? empRates.reduce((a, b) => a + b, 0) / empRates.length : 0;
    const nowYear = new Date().getFullYear();
    const trendLabels = [String(nowYear - 1), String(nowYear)];
    const trendValues = [Math.max(0, avg - 2), avg];

    const ctx = document.getElementById("internalTrendChart").getContext("2d");
    if (!internalTrendChartInstance) {
      internalTrendChartInstance = new Chart(ctx, {
        type: "line",
        data: {
          labels: trendLabels,
          datasets: [{
            label: "취업률(%)",
            data: trendValues,
            borderColor: "rgba(255, 193, 7, 0.9)",
            backgroundColor: "rgba(255, 193, 7, 0.25)",
            fill: true,
            tension: 0.25
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { y: { beginAtZero: true } }
        }
      });
    } else {
      internalTrendChartInstance.data.labels = trendLabels;
      internalTrendChartInstance.data.datasets[0].data = trendValues;
      internalTrendChartInstance.update();
    }
  }

  async function refreshPopulation() {
    const campus = document.getElementById("populationCampus").value;
    const admCd = document.getElementById("populationAdmCd").value;
    const admLabel = getSelectedOptionText("populationAdmCd");
    const populationYear = document.getElementById("populationYear").value;

    if (!campus) {
      setPopulationStatus("캠퍼스를 선택해 주세요.");
      return;
    }

    setPopulationStatus("조회 중...");

    const populationRes = await fetch(
      `/statistics/api/population/compare?campus=${encodeURIComponent(campus)}&admCd=${encodeURIComponent(admCd)}&populationYear=${encodeURIComponent(populationYear)}`
    );
    const populationData = await populationRes.json();

    if (!populationRes.ok) {
      setPopulationStatus(`인구 비교 에러: ${populationData?.message || "요청 실패"}`);
      return;
    }

    const usedPopulationYear = populationData.populationYear ?? populationYear;
    const campusSampleSize = populationData.campusStudentSampleSize ?? 0;
    const campusNote = campusSampleSize > 0 ? "" : " (캠퍼스 학생 연령/성별 데이터 없음 → 0으로 표시)";
    setPopulationStatus(
      `캠퍼스=${campus || "전체"} / 행정구역=${admLabel}(${admCd}) / 인구연도=${usedPopulationYear} / 캠퍼스표본=${campusSampleSize}명${campusNote}`
    );

    // population charts
    const popRows = populationData.rows || [];
    const popLabels = popRows.map((r) => r.ageBand);
    const regionRatios = popRows.map((r) => Number(r.regionRatio || 0));
    const campusRatios = popRows.map((r) => Number(r.campusRatio || 0));
    const popGaps = popRows.map((r) => Number(r.gap || 0));
    const regionMaleRatios = popRows.map((r) => Number(r.regionMaleRatio || 0));
    const campusMaleRatios = popRows.map((r) => Number(r.campusMaleRatio || 0));
    const maleGaps = popRows.map((r) => Number(r.maleGap || 0));
    const regionFemaleRatios = popRows.map((r) => Number(r.regionCount || 0) > 0 ? 100 - Number(r.regionMaleRatio || 0) : 0);
    const campusFemaleRatios = popRows.map((r) => Number(r.campusCount || 0) > 0 ? 100 - Number(r.campusMaleRatio || 0) : 0);

    const popDatasets = [
      { label: "행정구역 인구비율", data: regionRatios, backgroundColor: "rgba(255, 193, 7, 0.85)" },
      { label: "캠퍼스 학생비율", data: campusRatios, backgroundColor: "rgba(255, 87, 34, 0.85)" }
    ];

    const popGapDatasets = [
      { label: "GAP(%p)", data: popGaps, backgroundColor: "rgba(255, 193, 7, 0.85)" }
    ];

    if (!populationChartInstance) {
      populationChartInstance = renderBarChart("populationChart", popLabels, popDatasets);
    } else {
      updateChart(populationChartInstance, popLabels, popDatasets);
    }

    if (!populationGapChartInstance) {
      populationGapChartInstance = renderBarChart("populationGapChart", popLabels, popGapDatasets);
    } else {
      updateChart(populationGapChartInstance, popLabels, popGapDatasets);
    }

    const genderDatasets = [
      { label: "행정구역 남성", stack: "region", data: regionMaleRatios, backgroundColor: "rgba(255, 193, 7, 0.85)" },
      { label: "행정구역 여성", stack: "region", data: regionFemaleRatios, backgroundColor: "rgba(255, 193, 7, 0.35)" },
      { label: "캠퍼스 남성", stack: "campus", data: campusMaleRatios, backgroundColor: "rgba(255, 87, 34, 0.85)" },
      { label: "캠퍼스 여성", stack: "campus", data: campusFemaleRatios, backgroundColor: "rgba(255, 87, 34, 0.35)" }
    ];

    const genderGapDatasets = [
      { label: "남성비율 GAP(%p)", data: maleGaps, backgroundColor: "rgba(255, 193, 7, 0.85)" }
    ];

    if (!populationGenderChartInstance) {
      populationGenderChartInstance = renderStackedPercentChart("populationGenderChart", popLabels, genderDatasets);
    } else {
      updateChart(populationGenderChartInstance, popLabels, genderDatasets);
    }

    if (!populationGenderGapChartInstance) {
      populationGenderGapChartInstance = renderBarChart("populationGenderGapChart", popLabels, genderGapDatasets);
    } else {
      updateChart(populationGenderGapChartInstance, popLabels, genderGapDatasets);
    }

    // download buttons
    document.getElementById("downloadPopulationCsv").onclick = () => {
      // 왜: 서버에서 xlsx로 내려주면, 엑셀에서 바로 열 수 있고 한글 인코딩 이슈도 줄어듭니다.
      window.location.href = `/statistics/api/population/export?campus=${encodeURIComponent(campus)}&admCd=${encodeURIComponent(admCd)}&populationYear=${encodeURIComponent(populationYear)}`;
    };
    document.getElementById("downloadPopulationCsvTop").onclick = () => {
      window.location.href = `/statistics/api/population/export?campus=${encodeURIComponent(campus)}&admCd=${encodeURIComponent(admCd)}&populationYear=${encodeURIComponent(populationYear)}`;
    };
  }

  async function refreshIndustry() {
    const campus = document.getElementById("industryCampus").value;
    const admCd = document.getElementById("industryAdmCd").value;
    const admLabel = getSelectedOptionText("industryAdmCd");
    const statsYear = document.getElementById("industryYear").value;

    if (!campus) {
      setIndustryStatus("캠퍼스를 선택해 주세요.");
      return;
    }

    setIndustryStatus("조회 중...");

    const industryRes = await fetch(
      `/statistics/api/industry/analysis?campus=${encodeURIComponent(campus)}&admCd=${encodeURIComponent(admCd)}&statsYear=${encodeURIComponent(statsYear)}`
    );
    const industryData = await industryRes.json();

    if (!industryRes.ok) {
      setIndustryStatus(`산업 비교 에러: ${industryData?.message || "요청 실패"}`);
      return;
    }

    const usedIndustryYear = industryData.statsYear ?? statsYear;
    setIndustryStatus(
      `캠퍼스=${campus || "전체"} / 행정구역=${admLabel}(${admCd}) / 산업연도=${usedIndustryYear}`
    );

    // industry table + charts
    const industryRows = industryData.rows || [];
    const body = document.getElementById("industryTableBody");
    body.innerHTML = "";
    industryRows.forEach((r) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="text-start">${r.category ?? ""}</td>
        <td>${Number(r.regionRatio ?? 0).toFixed(2)}</td>
        <td>${Number(r.campusRatio ?? 0).toFixed(2)}</td>
        <td>${Number(r.gap ?? 0).toFixed(2)}</td>
      `;
      body.appendChild(tr);
    });

    const indLabels = industryRows.map((r) => r.category);
    const indRegion = industryRows.map((r) => Number(r.regionRatio || 0));
    const indCampus = industryRows.map((r) => Number(r.campusRatio || 0));
    const indGap = industryRows.map((r) => Number(r.gap || 0));

    const indDatasets = [
      { label: "행정구역 종사자 비율", data: indRegion, backgroundColor: "rgba(255, 193, 7, 0.85)" },
      { label: "캠퍼스 학생 비율", data: indCampus, backgroundColor: "rgba(255, 87, 34, 0.85)" }
    ];
    const indGapDatasets = [
      { label: "GAP(%p)", data: indGap, backgroundColor: "rgba(255, 193, 7, 0.85)" }
    ];

    if (!industryChartInstance) {
      industryChartInstance = renderBarChart("industryChart", indLabels, indDatasets);
    } else {
      updateChart(industryChartInstance, indLabels, indDatasets);
    }

    if (!industryGapChartInstance) {
      industryGapChartInstance = renderBarChart("industryGapChart", indLabels, indGapDatasets);
    } else {
      updateChart(industryGapChartInstance, indLabels, indGapDatasets);
    }

    // download buttons
    document.getElementById("downloadIndustryCsv").onclick = () => {
      window.location.href = `/statistics/api/industry/export?campus=${encodeURIComponent(campus)}&admCd=${encodeURIComponent(admCd)}&statsYear=${encodeURIComponent(statsYear)}`;
    };
    document.getElementById("downloadIndustryCsvTop").onclick = () => {
      window.location.href = `/statistics/api/industry/export?campus=${encodeURIComponent(campus)}&admCd=${encodeURIComponent(admCd)}&statsYear=${encodeURIComponent(statsYear)}`;
    };
  }

  function attachEvents() {
    // 왜: 인구/산업 탭이 분리되어, 각 탭의 필터 변경이 해당 탭만 갱신하도록 분리합니다.
    ["populationCampus", "populationAdmCd", "populationYear"].forEach((id) => {
      document.getElementById(id).addEventListener("change", refreshPopulation);
    });
    ["industryCampus", "industryAdmCd", "industryYear"].forEach((id) => {
      document.getElementById(id).addEventListener("change", refreshIndustry);
    });
    ["internalCampus"].forEach((id) => {
      document.getElementById(id).addEventListener("change", refreshInternal);
    });
  }

  async function init() {
    // 왜: 인구/산업은 통계 연도 선택이 별도로 필요할 수 있어, select를 각각 채웁니다.
    buildYearOptions("populationYear");
    buildYearOptions("industryYear");
    await loadMeta();
    attachEvents();
    await refreshInternal();
    await refreshPopulation();
    await refreshIndustry();
  }

  init();
</script>
</body>
</html>
