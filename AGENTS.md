# AGENTS.md (Repository Root)

## 목적 / 범위
- 이 문서는 MalgnLMS 저장소에서 에이전트가 작업할 때 지켜야 할 기본 규칙을 정의합니다.
- **[핵심 규칙] 모든 답변과 문서(진행 계획, md 파일 등)는 반드시 한글로 작성합니다.**
- 루트 `AGENTS.md` 규칙은 전체에 적용되며, 하위 폴더의 `AGENTS.md`가 있으면 해당 폴더 규칙이 우선합니다.

## [강제] 작업 전 필독(에이전트 전용)
- 이 저장소에서 에이전트가 **코드/문서를 수정하기 전에**, 반드시 아래 문서를 **순서대로** 읽고 그 규칙을 따릅니다.
  1) `AGENTS.md` (현재 파일)
  2) `CLAUDE.md`
  3) `claude/README.md`
  4) 작업 대상 폴더의 하위 `AGENTS.md` (있으면 그 규칙이 우선)
- `CLAUDE.md` 및 `claude/` 폴더는 “항상 참고시키기 위한 강제 규칙 세트”입니다.
  - 에이전트는 이 파일/폴더를 **임의로 삭제하거나 대규모로 변경하면 안 됩니다.**
  - 변경이 꼭 필요하면, 먼저 사용자에게 이유를 설명하고 **명시적으로 승인**을 받은 뒤 진행합니다.

## 프로젝트 구조/아키텍처 요약
- MalgnLMS는 Malgnsoft 공통 라이브러리 기반의 JSP + DAO 레거시 구조입니다.
- 대부분의 기능은 `public_html/.../*.jsp`가 컨트롤러/로직 역할을 하고, DB 접근은 `src/dao/*Dao.java`가 담당합니다.
- 화면은 JSP에서 `Page p`에 변수/루프를 세팅한 뒤, 대응되는 `.html` 템플릿을 `p.display()`로 렌더링합니다.
- `malgnsoft.db`/`malgnsoft.util` 패키지는 JAR로 포함된 공통 라이브러리이며, `DataObject`, `DataSet`, `Page`, `Malgn`, `Form`, `Auth` 등이 핵심입니다.

## 주요 디렉터리 역할
- `src/dao/`: DB 테이블 단위 DAO. `DataObject` 상속 후 `table/PK` 설정, `find/query/insert/update`를 사용합니다. 일부 도메인 로직(복사/배치 등)이 DAO에 포함돼 있습니다.
- `public_html/`: 웹 루트
  - `public_html/init.jsp`: 사용자(프론트) 공통 초기화. `m`, `f`, `p`, `siteinfo`, `Auth` 등을 세팅합니다.
  - `public_html/sysop/`: 관리자(백오피스) 기능 JSP. 각 모듈(과정/수료증/게시판/주문 등)별 폴더가 있습니다.
  - `public_html/sysop/init.jsp`: sysop 공통 초기화/권한/세션 처리.
  - `public_html/html/`: 프론트용 HTML 템플릿.
  - `public_html/sysop/html/`: sysop용 HTML 템플릿.
  - `public_html/inc/`, `public_html/common/`: 공통 include, JS/CSS/이미지.
  - `public_html/api/`: 외부/내부 API용 JSP 엔드포인트.
  - `public_html/data/`: 업로드/생성 파일 저장 위치(실서버에서는 doc_root 하위).
- `var/log/malgnlms/`: 에러/접속 등 로그.
- `resin/`, `resin.xml`: Resin WAS 설정(로컬/배포 환경별).

## 요청 처리 흐름(일반 패턴)
- JSP 상단에서 `init.jsp` 포함 → 공통 객체/권한/사이트 정보를 준비합니다.
- 화면 로직:
  - GET: DAO로 데이터 조회 → `p.setVar()/p.setLoop()`로 템플릿 변수 세팅 → `p.display()` 호출.
  - POST: `Form f`로 입력 검증(`addElement/validate`) 및 파일 저장(`saveFile`) → DAO `item()` 세팅 후 `insert/update` 수행.
- sysop 권한은 주로 `Menu.accessible(menuId, userId, userKind)`로 체크하며, `userKind`는 `S(슈퍼)`, `A(관리자)`, `C(과정운영자)` 등 코드로 구분됩니다.

## 템플릿(HTML) 문법 메모
- sysop/프론트 템플릿은 Malgn Page 문법을 사용합니다.
  - 조건: `<!--@if(name)--> ... <!--/if(name)-->`, `<!--@nif(name)--> ...`
  - 포함: `<!--@include(/path/file.html)-->`
  - 루프/변수는 JSP에서 `p.setLoop()/p.setVar()`로 주입합니다.

## 레거시 작업 시 주의
- 이 프로젝트는 Service 레이어가 없는 구조가 많으므로, 새 기능/수정 시 기존 JSP+DAO 패턴을 우선 존중합니다.
- `status` 컬럼은 관례적으로 `1=정상`, `0=중지`, `-1=삭제`를 의미하는 경우가 많습니다.
- 멀티사이트 구조가 있어 대부분 테이블에 `site_id`가 존재하므로, 쿼리/수정 시 항상 `site_id` 범위를 확인합니다.

## 커뮤니케이션 규칙
- 모든 답변은 존댓말로 작성합니다.
- 변경/제안/수정 시, 먼저 “왜 필요한지/왜 하는지”를 쉬운 말로 1~2문단 설명합니다.
- 사용자가 이해하기 쉬운 순서(문제 → 원인 → 해결 → 영향)로 설명합니다.
- 코딩 처음하는 중학생도 이해할수있도록 말한다.
- 절대 오버엔지니어링 하지 않는다.

## 코드 작성 원칙
- 신규/수정 로직에는 한글 주석으로 의도와 흐름을 설명합니다.
  - 주석은 “무엇을 하는지”보다 “왜 하는지/어떤 가정을 하는지”에 초점을 둡니다.
- **[금지] 폴백(fallback) 로직을 새로 추가하지 않습니다.**
  - 문제를 숨기거나 “일단 되게만” 만드는 우회 로직(조용히 기본값 처리, 실패를 성공처럼 처리, 예외를 삼키기 등)을 넣지 않습니다.
- **디버깅을 위한 로그를 적극 추가합니다.**
  - “어떤 입력으로, 어떤 분기/조건을 타서, 어떤 결과가 나왔는지”를 추적할 수 있게 핵심 지점에 로그를 남깁니다.
  - 단, 비밀번호/토큰/주민번호/이메일/전화번호 등 민감정보는 로그에 절대 남기지 않습니다(필요 시 마스킹).
  - 운영에 영향이 큰 과도한 로그(루프 내부 대량 출력 등)는 피하고, 필요한 범위에서만 남깁니다.
- **항상 서브 에이전트를 적극 활용합니다.**
- 메소드는 역할 단위로 분리하고, 의미 있는 메소드명으로 작성합니다.
  - 예: `validateCourseInput()`, `buildCertificateTemplate()`, `saveCourseAndRelatedData()`
- 긴 로직은 상위 메소드가 “목차”처럼 하위 메소드를 순서대로 호출하는 구조로 만듭니다.
  - 상위 메소드에는 흐름만 남기고, 상세 구현은 하위 메소드로 이동합니다.
- 레거시 코드에서는 기존 구조/네이밍/관례를 우선 존중하고, 새로 추가하거나 수정한 부분에 위 원칙을 점진적으로 적용합니다.
  - 사용자의 요청 없이 대규모 리팩터링(파일 이동, 광범위한 네이밍 변경, 구조 재편)은 하지 않습니다.
- `project/` 폴더 내 코드를 변경했으면 작업 끝에 `cd project && npm run build`로 마무리합니다.

## RPG-라이트(저장소 지도) 운영 지침 (강제)
왜 필요한가?
- 저장소가 크면 “관련 파일이 어디인지”를 매번 다시 찾느라 시간이 많이 듭니다(추론 단절).
- 그래서 **자주 쓰는 ‘흐름 지도’를 파일로 남겨** 에이전트와 사람이 같은 기준으로 빨리 찾고, 덜 틀리게 합니다.

무엇을 의미하나?
- 여기서 RPG-라이트는 “논문 수준의 그래프 시스템”이 아니라, 아래 3개 문서로 만드는 **가벼운 저장소 지도**를 뜻합니다.
  - `docs/rpg/map.md` : 모듈/진입점/파일 묶음 지도
  - `docs/rpg/flows.md` : 기능별 흐름(JSP → DAO → 템플릿/응답)
  - `docs/rpg/hotspots.md` : 자주 터지는/위험한 지점(주의사항)

항상 적용 규칙(강제)
1) Search-then-Zoom으로 작업합니다.
   - Search: `rg`로 후보를 넓게 찾습니다.
   - Zoom: 후보 1~3개로 좁혀 실제 흐름(입력→조회→출력)을 확인합니다.
   - Write: 최소 변경으로 고칩니다(오버엔지니어링 금지).
   - Verify: 최소 1회 실제 동작으로 확인합니다.
2) **파일을 수정/추가/삭제/이동했으면, 작업 끝에 `docs/rpg/`도 반드시 갱신합니다.**
   - JSP/DAO/템플릿/API 엔드포인트를 건드렸으면: `docs/rpg/flows.md`에 해당 흐름을 갱신합니다.
   - 파일 위치가 바뀌었거나 새로 생겼으면: `docs/rpg/map.md`에 반영합니다.
   - 운영 리스크가 큰 지점을 건드렸으면(권한/세션/결제/수료/통계/업로드 등): `docs/rpg/hotspots.md`에 주의사항을 갱신합니다.
   - “영향 없음”을 추측으로 쓰지 말고, 실제 확인 근거(어떤 화면/경로를 확인했는지)를 1줄이라도 남깁니다.
3) 결과 보고에 포함합니다.
   - 최종 답변에는 “수정한 파일”과 “함께 갱신한 `docs/rpg/*`”를 같이 적습니다.

## (권장) RPG-라이트 마무리 스크립트(작업 완료 전 실행)
왜 필요한가?
- “커밋 훅”은 커밋을 안 하면 동작하지 않아서, 작업 완료 시점에 문서가 최신이 아닐 수 있습니다.
- 그래서 작업을 끝내기 직전에 한 번 돌려, **에이전트/사람 모두** “항상 최신”을 보장합니다.

사용 방법
- 작업 완료(최종 답변) 직전에: `powershell -NoProfile -ExecutionPolicy Bypass -File tools/rpg/finish.ps1`
- (선택) 문서 자동 스테이징까지: `powershell -NoProfile -ExecutionPolicy Bypass -File tools/rpg/finish.ps1 -Stage`

## (권장) RPG-라이트 자동 강제(커밋 훅)
왜 필요한가?
- 사람이 “문서 갱신”을 깜빡해도, 커밋 전에 자동으로 `docs/rpg`를 최신으로 만들어 두기 위함입니다.

설정 방법(1회)
- `powershell -NoProfile -ExecutionPolicy Bypass -File tools/rpg/setup-githooks.ps1`

동작
- 커밋 시 `.githooks/pre-commit`이 `tools/rpg/generate.ps1`를 실행하고 `docs/rpg`를 자동 스테이징합니다.

## (선택) 레이어/언어별 규칙
- Java: DAO는 DB 접근만 담당, 비즈니스 로직은 Service에 둡니다.
- JSP/HTML: 화면 로직과 서버 로직을 분리하고, 중복되는 스크립트는 공통화합니다.
- 기타 프로젝트 고유 규칙이 있다면 여기에 추가합니다.

## (선택) 작업 절차 / 검증
- 변경 시 관련 주석/문서도 함께 갱신합니다.
- 가능한 경우 로컬에서 최소 단위 테스트 또는 기능 확인을 수행합니다.
- 테스트/실행 명령이 있다면 여기에 기입합니다.
