<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>교수자 대시보드 - 한국폴리텍대학 LMS</title>
    <link rel="stylesheet" href="../../common/css/unified-theme.css">
    <link rel="stylesheet" href="../../common/css/phase2-components.css">
    <style>
        :root {
            --primary-color: #7c3aed;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
        }

        .stat-card h3 {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .data-table {
            width: 100%;
            background: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
            margin-bottom: 32px;
        }

        .data-table th,
        .data-table td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            background: #f8fafc;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tr:hover {
            background: #f8fafc;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success { background: #dcfce7; color: #166534; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-info { background: #ede9fe; color: #5b21b6; }
        .badge-locked { background: #e2e8f0; color: #475569; }

        .btn {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: #6d28d9;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .btn-outline:hover {
            background: #f1f5f9;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .actions-cell {
            display: flex;
            gap: 8px;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #e2e8f0;
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .grade-input-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .hidden {
            display: none !important;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }

        .tab {
            padding: 10px 20px;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .tab.active {
            color: var(--primary-color);
            background: #f5f3ff;
        }

        .tab:hover:not(.active) {
            background: #f1f5f9;
        }

        .course-select {
            padding: 10px 14px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            min-width: 200px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="page-header">
            <h1 class="page-title">교수자 대시보드</h1>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">김</div>
                <div>
                    <div style="font-weight: 600;" id="userName">김교수</div>
                    <div style="font-size: 13px; color: var(--text-secondary);" id="userDept">컴퓨터소프트웨어과</div>
                </div>
            </div>
        </header>

        <!-- 통계 카드 -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>담당 강좌</h3>
                <div class="stat-value" id="courseCount">-</div>
            </div>
            <div class="stat-card">
                <h3>총 수강생</h3>
                <div class="stat-value" id="studentCount">-</div>
            </div>
            <div class="stat-card">
                <h3>평균 출석률</h3>
                <div class="stat-value" id="avgAttendance">-</div>
            </div>
            <div class="stat-card">
                <h3>성적 미등록</h3>
                <div class="stat-value" id="ungradedCount">-</div>
            </div>
        </div>

        <!-- 탭 메뉴 -->
        <div class="tabs">
            <div class="tab active" data-tab="courses">담당 강좌</div>
            <div class="tab" data-tab="attendance">출결 관리</div>
            <div class="tab" data-tab="grades">성적 관리</div>
            <div class="tab" data-tab="syllabus">강의계획서</div>
        </div>

        <!-- 담당 강좌 목록 -->
        <section id="coursesTab">
            <h2 class="section-title">담당 강좌 목록</h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>강좌코드</th>
                        <th>강좌명</th>
                        <th>학과</th>
                        <th>수강생</th>
                        <th>진행상태</th>
                        <th>계획서</th>
                        <th>작업</th>
                    </tr>
                </thead>
                <tbody id="courseList">
                    <tr>
                        <td colspan="7" class="loading">
                            <div class="spinner"></div>
                            데이터를 불러오는 중...
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- 출결 관리 -->
        <section id="attendanceTab" class="hidden">
            <h2 class="section-title">출결 관리</h2>
            <select class="course-select" id="attendanceCourseSelect">
                <option value="">강좌 선택</option>
            </select>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>학번</th>
                        <th>이름</th>
                        <th>분반</th>
                        <th>출석</th>
                        <th>지각</th>
                        <th>결석</th>
                        <th>출석률</th>
                        <th>상태</th>
                    </tr>
                </thead>
                <tbody id="attendanceList">
                    <tr><td colspan="8">강좌를 선택하세요.</td></tr>
                </tbody>
            </table>
        </section>

        <!-- 성적 관리 -->
        <section id="gradesTab" class="hidden">
            <h2 class="section-title">성적 관리</h2>
            <select class="course-select" id="gradeCourseSelect">
                <option value="">강좌 선택</option>
            </select>

            <!-- 성적 기준 -->
            <div id="gradeCriteriaSection" style="display: none; margin-bottom: 24px;">
                <h3 style="font-size: 16px; margin-bottom: 12px;">성적 비율 설정</h3>
                <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
                    <div>
                        <label class="form-label">출석</label>
                        <input type="number" id="criteriaAttendance" class="form-input" style="width: 80px;" min="0" max="100">%
                    </div>
                    <div>
                        <label class="form-label">중간고사</label>
                        <input type="number" id="criteriaMidterm" class="form-input" style="width: 80px;" min="0" max="100">%
                    </div>
                    <div>
                        <label class="form-label">기말고사</label>
                        <input type="number" id="criteriaFinal" class="form-input" style="width: 80px;" min="0" max="100">%
                    </div>
                    <div>
                        <label class="form-label">과제</label>
                        <input type="number" id="criteriaAssignment" class="form-input" style="width: 80px;" min="0" max="100">%
                    </div>
                    <button class="btn btn-primary" onclick="saveCriteria()">기준 저장</button>
                </div>
                <div id="criteriaLockMessage" class="hidden" style="margin-top: 12px; color: var(--danger-color); font-size: 14px;"></div>
            </div>

            <table class="data-table">
                <thead>
                    <tr>
                        <th>학번</th>
                        <th>이름</th>
                        <th>출석</th>
                        <th>중간고사</th>
                        <th>기말고사</th>
                        <th>과제</th>
                        <th>총점</th>
                        <th>학점</th>
                        <th>작업</th>
                    </tr>
                </thead>
                <tbody id="gradeList">
                    <tr><td colspan="9">강좌를 선택하세요.</td></tr>
                </tbody>
            </table>
        </section>

        <!-- 강의계획서 -->
        <section id="syllabusTab" class="hidden">
            <h2 class="section-title">강의계획서 관리</h2>
            <select class="course-select" id="syllabusCourseSelect">
                <option value="">강좌 선택</option>
            </select>
            <div id="syllabusContent" style="background: var(--card-bg); border-radius: 12px; padding: 24px; border: 1px solid var(--border-color);">
                <p>강좌를 선택하세요.</p>
            </div>
        </section>
    </div>

    <!-- 성적 입력 모달 -->
    <div class="modal-overlay hidden" id="gradeModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">성적 입력</h3>
                <button class="modal-close" onclick="closeGradeModal()">&times;</button>
            </div>
            <form id="gradeForm">
                <input type="hidden" id="gradeStudentKey">
                <div class="form-group">
                    <label class="form-label">학생</label>
                    <input type="text" id="gradeStudentName" class="form-input" readonly>
                </div>
                <div class="grade-input-grid">
                    <div class="form-group">
                        <label class="form-label">출석</label>
                        <input type="number" id="gradeAttendance" class="form-input" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label class="form-label">중간고사</label>
                        <input type="number" id="gradeMidterm" class="form-input" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label class="form-label">기말고사</label>
                        <input type="number" id="gradeFinal" class="form-input" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label class="form-label">과제</label>
                        <input type="number" id="gradeAssignment" class="form-input" min="0" max="100">
                    </div>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-outline" onclick="closeGradeModal()">취소</button>
                    <button type="submit" class="btn btn-primary">저장</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = '/api/haksa';

        const currentUser = {
            memberKey: 'P2026001',
            name: '김교수',
            dept: '컴퓨터소프트웨어과'
        };

        let courses = [];
        let selectedCourse = null;
        let criteriaLocked = false;

        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userDept').textContent = currentUser.dept;
            document.getElementById('userAvatar').textContent = currentUser.name.charAt(0);

            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });

            document.getElementById('attendanceCourseSelect').addEventListener('change', (e) => {
                if (e.target.value) loadCourseAttendance(e.target.value);
            });

            document.getElementById('gradeCourseSelect').addEventListener('change', (e) => {
                if (e.target.value) loadCourseGrades(e.target.value);
            });

            document.getElementById('syllabusCourseSelect').addEventListener('change', (e) => {
                if (e.target.value) loadSyllabus(e.target.value);
            });

            document.getElementById('gradeForm').addEventListener('submit', saveGrade);

            await loadDashboard();
        });

        async function loadDashboard() {
            try {
                const response = await fetch(`${API_BASE}/dashboard/professor/${currentUser.memberKey}`);
                const result = await response.json();

                if (result.success) {
                    courses = result.courses || [];

                    document.getElementById('courseCount').textContent = courses.length;

                    let totalStudents = 0;
                    for (const c of courses) {
                        const resp = await fetch(`${API_BASE}/courses/${c.COURSE_CODE}/students`);
                        const data = await resp.json();
                        totalStudents += data.count || 0;
                    }
                    document.getElementById('studentCount').textContent = totalStudents;
                    document.getElementById('avgAttendance').textContent = '95%';
                    document.getElementById('ungradedCount').textContent = totalStudents;

                    renderCourseList(courses);
                    populateCourseSelects(courses);
                }
            } catch (error) {
                console.error('대시보드 로드 실패:', error);
            }
        }

        function renderCourseList(courses) {
            const tbody = document.getElementById('courseList');

            if (courses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7">담당 강좌가 없습니다.</td></tr>';
                return;
            }

            tbody.innerHTML = courses.map(c => `
                <tr>
                    <td>${c.COURSE_CODE}</td>
                    <td>${c.COURSE_NAME || '-'}</td>
                    <td>${c.DEPT_NAME || '-'}</td>
                    <td>-</td>
                    <td><span class="badge badge-success">진행중</span></td>
                    <td><span class="badge ${c.IS_SYLLABUS === 'Y' ? 'badge-success' : 'badge-warning'}">${c.IS_SYLLABUS === 'Y' ? '등록됨' : '미등록'}</span></td>
                    <td class="actions-cell">
                        <button class="btn btn-outline btn-sm" onclick="viewCourse('${c.COURSE_CODE}')">상세</button>
                    </td>
                </tr>
            `).join('');
        }

        function populateCourseSelects(courses) {
            const options = courses.map(c => `<option value="${c.COURSE_CODE}">${c.COURSE_NAME || c.COURSE_CODE}</option>`).join('');
            document.getElementById('attendanceCourseSelect').innerHTML = '<option value="">강좌 선택</option>' + options;
            document.getElementById('gradeCourseSelect').innerHTML = '<option value="">강좌 선택</option>' + options;
            document.getElementById('syllabusCourseSelect').innerHTML = '<option value="">강좌 선택</option>' + options;
        }

        async function loadCourseAttendance(courseCode) {
            const tbody = document.getElementById('attendanceList');
            tbody.innerHTML = '<tr><td colspan="8" class="loading"><div class="spinner"></div>로딩중...</td></tr>';

            try {
                const response = await fetch(`${API_BASE}/attendance/course/${courseCode}`);
                const data = await response.json();

                const students = data.students || [];
                if (students.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8">수강생이 없습니다.</td></tr>';
                    return;
                }

                tbody.innerHTML = students.map(s => {
                    const summary = s.summary || {};
                    const rate = summary.attendanceRate || 0;
                    let badgeClass = 'badge-success';
                    let statusText = '양호';

                    if (rate < 70) {
                        badgeClass = 'badge-danger';
                        statusText = '위험';
                    } else if (rate < 85) {
                        badgeClass = 'badge-warning';
                        statusText = '주의';
                    }

                    return `
                        <tr>
                            <td>${s.studentNo}</td>
                            <td>${s.name}</td>
                            <td>${s.className}</td>
                            <td>${summary.present || 0}</td>
                            <td>${summary.late || 0}</td>
                            <td>${summary.absent || 0}</td>
                            <td>${rate}%</td>
                            <td><span class="badge ${badgeClass}">${statusText}</span></td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="8">데이터 로드 실패</td></tr>';
            }
        }

        async function loadCourseGrades(courseCode) {
            selectedCourse = courseCode;
            const tbody = document.getElementById('gradeList');
            tbody.innerHTML = '<tr><td colspan="9" class="loading"><div class="spinner"></div>로딩중...</td></tr>';

            // 성적 기준 로드
            try {
                const criteriaResp = await fetch(`${API_BASE}/grade/criteria/${courseCode}`);
                const criteriaData = await criteriaResp.json();
                const criteria = criteriaData.criteria || {};

                document.getElementById('criteriaAttendance').value = criteria.attendance || 10;
                document.getElementById('criteriaMidterm').value = criteria.midterm || 30;
                document.getElementById('criteriaFinal').value = criteria.finalExam || 40;
                document.getElementById('criteriaAssignment').value = criteria.assignment || 20;

                criteriaLocked = criteriaData.isLocked;
                const inputs = document.querySelectorAll('#gradeCriteriaSection input');
                inputs.forEach(i => i.disabled = criteriaLocked);

                if (criteriaLocked) {
                    document.getElementById('criteriaLockMessage').textContent = criteriaData.lockedReason;
                    document.getElementById('criteriaLockMessage').classList.remove('hidden');
                } else {
                    document.getElementById('criteriaLockMessage').classList.add('hidden');
                }

                document.getElementById('gradeCriteriaSection').style.display = 'block';
            } catch (e) {
                console.error('기준 로드 실패', e);
            }

            // 성적 데이터 로드
            try {
                const response = await fetch(`${API_BASE}/grade/course/${courseCode}`);
                const data = await response.json();

                const grades = data.grades || [];
                if (grades.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9">수강생이 없습니다.</td></tr>';
                    return;
                }

                tbody.innerHTML = grades.map(g => {
                    const scores = g.scores || {};
                    return `
                        <tr>
                            <td>${g.studentNo || '-'}</td>
                            <td>${g.name || '-'}</td>
                            <td>${g.hasGrade ? scores.attendance : '-'}</td>
                            <td>${g.hasGrade ? scores.midterm : '-'}</td>
                            <td>${g.hasGrade ? scores.finalExam : '-'}</td>
                            <td>${g.hasGrade ? scores.assignment : '-'}</td>
                            <td><strong>${g.hasGrade ? g.totalScore : '-'}</strong></td>
                            <td>${g.hasGrade ? `<span class="badge badge-info">${g.grade}</span>` : '-'}</td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick="openGradeModal('${g.memberKey}', '${g.name || '-'}', ${JSON.stringify(scores).replace(/"/g, '&quot;')})">입력</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="9">데이터 로드 실패</td></tr>';
            }
        }

        async function saveCriteria() {
            if (criteriaLocked) {
                alert('성적 기준이 잠겨 있어 수정할 수 없습니다.');
                return;
            }

            const criteria = {
                attendance: parseInt(document.getElementById('criteriaAttendance').value),
                midterm: parseInt(document.getElementById('criteriaMidterm').value),
                finalExam: parseInt(document.getElementById('criteriaFinal').value),
                assignment: parseInt(document.getElementById('criteriaAssignment').value)
            };

            const total = criteria.attendance + criteria.midterm + criteria.finalExam + criteria.assignment;
            if (total !== 100) {
                alert(`비율 합계가 100%가 아닙니다. (현재: ${total}%)`);
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/grade/criteria/${selectedCourse}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(criteria)
                });
                const result = await response.json();

                if (result.success) {
                    alert('성적 기준이 저장되었습니다.');
                } else {
                    alert(result.reason || '저장 실패');
                }
            } catch (error) {
                alert('저장 중 오류 발생');
            }
        }

        async function loadSyllabus(courseCode) {
            const container = document.getElementById('syllabusContent');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>로딩중...</div>';

            try {
                const response = await fetch(`${API_BASE}/syllabus/${courseCode}`);
                const result = await response.json();
                const data = result.data;

                if (!data.hasSyllabus) {
                    container.innerHTML = `
                        <p>${data.message}</p>
                        <button class="btn btn-primary" style="margin-top: 16px;" onclick="importSyllabus('${courseCode}')">학사포털에서 가져오기</button>
                    `;
                    return;
                }

                const courseInfo = data.courseInfo || {};
                const professors = data.professors || [];
                const weeklyPlans = data.weeklyPlans || [];

                container.innerHTML = `
                    <div style="margin-bottom: 24px;">
                        <h3 style="font-size: 18px; margin-bottom: 12px;">강좌 정보</h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                            <div><strong>강좌명:</strong> ${courseInfo.courseName || '-'}</div>
                            <div><strong>학점:</strong> ${courseInfo.credit || '-'}</div>
                            <div><strong>이론/실습:</strong> ${courseInfo.theoryHours || 0}/${courseInfo.practiceHours || 0}시간</div>
                            <div><strong>학과:</strong> ${courseInfo.deptName || '-'}</div>
                            <div><strong>유형:</strong> ${data.syllabusType || '-'}</div>
                            <div><strong>기간:</strong> ${courseInfo.startDate || '-'} ~ ${courseInfo.endDate || '-'}</div>
                        </div>
                    </div>

                    <div style="margin-bottom: 24px;">
                        <h3 style="font-size: 18px; margin-bottom: 12px;">담당 교수</h3>
                        <p>${professors.map(p => p.KOR_NAME + ' (' + p.ROLE + ')').join(', ') || '-'}</p>
                    </div>

                    <div>
                        <h3 style="font-size: 18px; margin-bottom: 12px;">주차별 강의 계획</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>주차</th>
                                    <th>강의 내용</th>
                                    <th>학습목표</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${weeklyPlans.map(p => `
                                    <tr>
                                        <td>${p.LSN_WEKORD}주차</td>
                                        <td>${p.LSN_TITLE || '-'}</td>
                                        <td>${p.LSN_GOAL || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div style="margin-top: 20px; display: flex; gap: 12px;">
                        <button class="btn btn-primary" onclick="downloadSyllabusPdf('${courseCode}')">PDF 다운로드</button>
                        <button class="btn btn-outline" onclick="importSyllabus('${courseCode}')">다시 가져오기</button>
                    </div>
                `;
            } catch (error) {
                container.innerHTML = '<p>데이터 로드 실패</p>';
            }
        }

        async function importSyllabus(courseCode) {
            try {
                const response = await fetch(`${API_BASE}/syllabus/${courseCode}/import`, { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    alert('강의계획서를 가져왔습니다.');
                    loadSyllabus(courseCode);
                } else {
                    alert(result.reason || '가져오기 실패');
                }
            } catch (error) {
                alert('오류 발생');
            }
        }

        async function downloadSyllabusPdf(courseCode) {
            try {
                const response = await fetch(`${API_BASE}/syllabus/${courseCode}/pdf`);
                const result = await response.json();
                alert(`PDF 생성 완료: ${result.pdfUrl}`);
            } catch (error) {
                alert('PDF 생성 실패');
            }
        }

        function openGradeModal(memberKey, name, scores) {
            document.getElementById('gradeStudentKey').value = memberKey;
            document.getElementById('gradeStudentName').value = name;
            document.getElementById('gradeAttendance').value = scores.attendance || '';
            document.getElementById('gradeMidterm').value = scores.midterm || '';
            document.getElementById('gradeFinal').value = scores.finalExam || '';
            document.getElementById('gradeAssignment').value = scores.assignment || '';
            document.getElementById('gradeModal').classList.remove('hidden');
        }

        function closeGradeModal() {
            document.getElementById('gradeModal').classList.add('hidden');
        }

        async function saveGrade(e) {
            e.preventDefault();

            const memberKey = document.getElementById('gradeStudentKey').value;
            const scores = {
                attendance: parseInt(document.getElementById('gradeAttendance').value) || 0,
                midterm: parseInt(document.getElementById('gradeMidterm').value) || 0,
                finalExam: parseInt(document.getElementById('gradeFinal').value) || 0,
                assignment: parseInt(document.getElementById('gradeAssignment').value) || 0
            };

            try {
                const response = await fetch(`${API_BASE}/grade/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        courseCode: selectedCourse,
                        memberKey,
                        scores
                    })
                });
                const result = await response.json();

                if (result.hasGrade) {
                    alert('성적이 저장되었습니다.');
                    closeGradeModal();
                    loadCourseGrades(selectedCourse);
                }
            } catch (error) {
                alert('저장 실패');
            }
        }

        function viewCourse(courseCode) {
            switchTab('grades');
            document.getElementById('gradeCourseSelect').value = courseCode;
            loadCourseGrades(courseCode);
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            ['coursesTab', 'attendanceTab', 'gradesTab', 'syllabusTab'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
        }
    </script>
</body>
</html>
