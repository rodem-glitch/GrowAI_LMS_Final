<table class="c_tb01" cellpadding="0" cellspacing="0">
<tr>
	<td class="c_th01">다중 영상 차시 구성</td>
	<td class="c_td01" align="right">
		<strong>[{{course.course_nm}}]</strong> {{lesson.lesson_nm}}
	</td>
</tr>
</table>

<!-- 현재 등록된 서브영상 목록 / 순서 저장 -->
<form name="form_save" method="post" target="sysfrm" onsubmit="return saveVideos(this);">
<input type="hidden" name="mode" value="save">
<input type="hidden" name="cid" value="{{cid}}">
<input type="hidden" name="lid" value="{{lid}}">
<input type="hidden" name="chapter" value="{{chapter}}">

<table class="a_tb01" cellpadding="0" cellspacing="0" border="0" style="width:100%">
<tr>
	<td class="a_th01">등록된 영상 목록</td>
	<td class="a_td01" align="right">
		<button type="submit" class="bttn2 blue">순서/구성 저장</button>
	</td>
</tr>
</table>

<table id="video_list" class="l_tb01" cellpadding="0" cellspacing="0" style="table-layout:fixed;">
<colgroup>
<col width="50">
<col>
<col width="90">
<col width="90">
<col width="70">
<col width="40">
</colgroup>
<thead>
<tr align="center">
	<td class="l_th01">No</td>
	<td class="l_th01">서브영상(강의)</td>
	<td class="l_th01">학습시간</td>
	<td class="l_th01">인정시간</td>
	<td class="l_th01">삭제</td>
	<td class="l_th01">정렬</td>
</tr>
</thead>
<tbody>
<!--@loop(video_list)-->
<tr align="center">
	<td class="l_td01 video_no">{{video_list.__ord}}
		<input type="hidden" name="video_id" value="{{video_list.video_id}}">
		<input type="hidden" class="video_key_md5" value="{{video_list.video_key_md5}}">
	</td>
	<td class="l_td01" align="left">{{video_list.lesson_nm}}</td>
	<td class="l_td01" align="center">{{video_list.total_time}}분</td>
	<td class="l_td01" align="center">{{video_list.complete_time}}분</td>
	<td class="l_td01" align="center"><input type="button" class="btn_simp" value="삭제" onclick="removeVideo(this);"></td>
	<td class="l_td01 l_sort02">↕</td>
</tr>
<!--/loop(video_list)-->
</tbody>
</table>

<!--@nif(video_list)-->
<table class="n_tb01" cellpadding="0" cellspacing="0">
<tr><td>등록된 서브영상이 없습니다. 아래에서 선택해서 추가하세요.</td></tr>
</table>
<!--/nif(video_list)-->

</form>

<script>
function renumberVideos() {
	$("#video_list tbody tr").each(function(i) {
		$(this).find(".video_no").contents().first()[0].textContent = (i + 1);
	});
}
function removeVideo(btn) {
	$(btn).closest("tr").remove();
	renumberVideos();
}
function saveVideos(f) {
	if($("#video_list tbody tr").length == 0) {
		return confirm("서브영상이 없으면 다중영상 설정이 해제됩니다. 저장하시겠습니까?");
	}
	return true;
}
addEvent("onload", function() {
	try { $("#video_list").tableSortable({ items: "tr" }); } catch(e) { }
});
</script>

<hr class="line01">

<!-- 서브영상 선택/추가 -->
<form name="form_search" method="get">
<input type="hidden" name="cid" value="{{cid}}">
<input type="hidden" name="lid" value="{{lid}}">
<input type="hidden" name="chapter" value="{{chapter}}">
<input type="hidden" name="s_listnum" value="">

<table class="t_tb01" cellpadding="0" cellspacing="0" style="table-layout:fixed;">
<col width="120"><col>
<tr>
	<td class="t_th01">콘텐츠목록</td>
	<td class="t_td01">
		<select name="s_content" class="js-example-basic-single">
		<option value=""> - 전체 - </option>
		<option value="0"> [미지정] </option>
		<!--@loop(content_list)-->
		<option value="{{content_list.id}}"> {{content_list.content_nm}} </option>
		<!--/loop(content_list)-->
		</select>
	</td>
</tr>
<tr>
	<td class="t_th01">콘텐츠타입</td>
	<td class="t_td01">
		<label><input type="radio" value="" name="s_type" class="ipt01" checked> 전체 </label>&nbsp;
		<!--@loop(types)-->
		<label><input type="radio" value="{{types.id}}" name="s_type" class="ipt01"> {{types.name}} </label> &nbsp;
		<!--/loop(types)-->
	</td>
</tr>
<tr>
	<td class="t_th01">검색</td>
	<td class="t_td01">
		<select name="s_field" onchange="document.forms['form_search']['s_keyword'].focus();">
			<option value=""> - 전체 - </option>
			<option value="a.lesson_nm">강의명</option>
			<option value="a.author">저작자</option>
			<option value="a.start_url">시작파일</option>
			<option value="c.content_nm">콘텐츠명</option>
		</select>
		<input type="text" name="s_keyword" size="30" onfocus="this.select();">
		<button type="submit" class="bttn2">검색</button>
	</td>
</tr>
</table>
</form>
{{form_script}}

<form name="form_add" method="post" target="sysfrm">
<input type="hidden" name="mode" value="add">
<input type="hidden" name="cid" value="{{cid}}">
<input type="hidden" name="lid" value="{{lid}}">
<input type="hidden" name="chapter" value="{{chapter}}">

<table class="a_tb01" cellpadding="0" cellspacing="0" border="0">
<tr>
	<td class="a_th01">
		{{list_total}} &nbsp;
		<select name="s_listnum" onchange="document.forms['form_search']['s_listnum'].value=this.value; document.forms['form_search'].submit();">
			<option value="20">20</option>
			<option value="50">50</option>
			<option value="100">100</option>
		</select> 건씩 보기
	</td>
	<td class="a_td01" align="right">
		<button type="button" class="bttn2" onclick="addSelected();">선택추가</button>
	</td>
</tr>
</table>

<table class="l_tb01" cellpadding="0" cellspacing="0" style="table-layout:fixed;">
<colgroup>
<col width="50">
<col width="155">
<col>
<col width="70">
<col width="80">
<col width="40">
</colgroup>
<thead>
<tr align="center">
	<td class="l_th01">No</td>
	<td class="l_th01">콘텐츠타입</td>
	<td class="l_th01">강의명</td>
	<td class="l_th01">시간</td>
	<td class="l_th01">등록일</td>
	<td class="l_th01"><input type="checkbox" onclick="AutoCheck('form_add', 'lidx'); try { syncDuplicateSelection(true); } catch(e) {}"></td>
</tr>
</thead>
<tbody>
<!--@loop(list)-->
<tr class="l_tr_{{list.ROW_CLASS}}" align="center">
	<td class="l_td01">{{list.__ord}}</td>
	<td class="l_td01" align="left"><span class="label">{{list.onoff_type_conv}}</span> {{list.lesson_type_conv}}</td>
	<td class="l_td01 l_td_el" align="left" alt="[{{list.content_nm_conv}}] {{list.lesson_nm}}">
		<!--@if(list.content_nm_conv)--><span class="label gray">{{list.content_nm_conv}}</span><!--/if(list.content_nm_conv)-->
		{{list.lesson_nm}}
	</td>
	<td class="l_td01" align="right">{{list.total_time_conv}}분</td>
	<td class="l_td01">{{list.reg_date_conv}}</td>
	<td class="l_td01"><input type="checkbox" name="lidx" value="{{list.id}}" data-video-key="{{list.video_key_md5}}"></td>
</tr>
<!--/loop(list)-->
</tbody>
</table>

<!--@nif(list)-->
<table class="n_tb01" cellpadding="0" cellspacing="0">
<tr><td>해당 자료가 없습니다.</td></tr>
</table>
<!--/nif(list)-->

<table class="p_tb01" cellpadding="0" cellspacing="0">
<tr><td class="p_td01">{{pagebar}}</td></tr>
</table>
</form>

<style>
/* 왜: “이미 등록된 영상과 같은 키”는 선택 자체를 막아야 혼란이 없습니다. */
tr.dup_block { opacity:0.55; }
tr.dup_block td { color:#777777; }
</style>

<script>
function getLockedVideoKeys() {
	//왜: 이미 등록된 목록(위쪽 테이블)과 “부모(메인) 영상”과 같은 영상키는 중복이므로 선택을 막아야 합니다.
	var locked = {};
	var parentKey = ("{{parent_video_key_md5}}" || "").trim();
	if(parentKey != "") locked[parentKey] = true;

	$("#video_list input.video_key_md5").each(function() {
		var k = ("" + ($(this).val() || "")).trim();
		if(k != "") locked[k] = true;
	});
	return locked;
}

function applyLockedVideoKeys() {
	//왜: 화면에서 미리 막아주면 “선택했는데 저장 후 사라짐” 같은 헷갈림이 줄어듭니다.
	var locked = getLockedVideoKeys();
	$("input[name='lidx']").each(function() {
		var k = ("" + (this.getAttribute("data-video-key") || "")).trim();
		if(k != "" && locked[k]) {
			this.checked = false;
			this.disabled = true;
			try { $(this).closest("tr").addClass("dup_block"); } catch(e) { }
		}
	});
}

function syncDuplicateSelection(showAlert) {
	//왜: 목록 안에 “키가 같은 레슨”이 여러 개 있을 수 있으니, 한 번에 여러 개를 체크하지 못하게 합니다.
	var locked = getLockedVideoKeys();
	var seen = {};
	var removed = 0;

	$("input[name='lidx']:checked").each(function() {
		var k = ("" + (this.getAttribute("data-video-key") || "")).trim();
		if(k == "") return;
		if(locked[k]) { this.checked = false; removed++; return; }
		if(seen[k]) { this.checked = false; removed++; return; }
		seen[k] = true;
	});

	if(removed > 0 && showAlert) {
		alert("같은 영상은 1개만 선택할 수 있습니다.\\n(중복된 항목은 자동으로 해제되었습니다.)");
	}
	return removed == 0;
}

function addSelected() {
	syncDuplicateSelection(true);
	if(!GetFormValue("form_add", "lidx")) {
		alert("선택 항목이 없습니다.");
		return;
	}
	document.forms["form_add"].submit();
}
addEvent("onload", function() {
	try {
		var progresses = { "온라인" : "sky", "집합" : "red", "혼합" : "green", "패키지" : "brown", "화상" : "yellow" };
		$(".label").each(function() {
			var v = $(this).html();
			$(this).addClass(progresses[v]);
		});
	} catch(e) { }

	//왜: 페이지가 열리자마자 “이미 중복인 항목”은 비활성 처리해 혼란을 줄입니다.
	try { applyLockedVideoKeys(); } catch(e) { }

	//왜: 체크할 때 즉시 중복을 풀어주면 사용자가 “왜 1개만 남지?”를 덜 겪습니다.
	try {
		$(document).on("change", "input[name='lidx']", function() {
			if(this.checked) syncDuplicateSelection(true);
		});
	} catch(e) { }
});
</script>
