<!DOCTYPE html>
<html lang="ko">
<head>
<title>AI Chat</title>
<link rel="stylesheet" type="text/css" href="/common/css/fontawesome/css/font-awesome.min.css">
<link rel="stylesheet" type="text/css" href="/common/css/fontawesome5/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/common/theme/css/font_NanumSquare.css?t={{CURR_DATE}}" >
<link rel="stylesheet" type="text/css" href="/common/theme/css/blue_theme.css?t={{CURR_DATE}}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.min.css">

<link rel="stylesheet" type="text/css" href="/common/theme/ai/ai.css?t={{CURR_DATE}}">

<link rel="stylesheet" type="text/css" href="/html/css/custom.css?t={{CURR_DATE}}">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.min.js"></script>
</head>
<body>
<div class="chatBox">
<div class="answerContainer">
    <p class="answer">안녕하세요. AI 채팅 도우미입니다. 무엇이든 질문해 주세요.</p>
</div>
<!--@loop(list)-->
<div class="queryContainer">
    <p class="query">{{list.question}}</p>
</div>
<div class="answerContainer">
    <p class="answer">{{list.answer}}</p>
</div>
<!--/loop(list)-->
</div>
<div class="bottom">
<form class="chatForm" id="chatForm">
    <input type="text" class="chatGPTQuestion" name="query_text" autocomplete="off">
    <i id="sendButton" class="fa fa-arrow-circle-right"></i>
    <div id="dots" class="dot-flashing"></div>
</form>
</div>
<script>
var parent_id = "{{parent_id}}";
var isQuery = false;
var scrollInterval;

$(window).resize(resizeChatBox);
function getContentHeight() {
    return $(window).height() - 8 - $(".bottom").height() - 32;
}

function resizeChatBox() {
    const chatBox = $(".chatBox");
    const h = getContentHeight();
    chatBox.css("height", h);
    setTimeout(function() {
        chatBox.mCustomScrollbar("scrollTo", "bottom");
    }, 100);
}

$(document).ready(function() {
    $("#dots").hide();
    $("#chatForm").on("submit", function(e) {
        e.preventDefault();
        if(!isQuery) sendQuery();
    });

    $(".chatBox").mCustomScrollbar({
        axis:"y",
        advanced:{
            updateOnContentResize: true,
            updateOnImageLoad: true,
            updateOnSelectorChange: this,
        }
    });
    resizeChatBox();
});

function sendQuery() {
    isQuery = true;
    const arrowSend = $("#sendButton");
    const loadingDots = $("#dots");

    const chatGPTResp = $(".chatBox > div > div");
    const chatGPTQuestion = $("input[name=query_text]");

    const newQueryContainer = document.createElement("div");
    newQueryContainer.className = "queryContainer";
    const newParagraph = document.createElement("p");

    newParagraph.className = "query";
    newParagraph.innerHTML = chatGPTQuestion.val();
    newQueryContainer.appendChild(newParagraph);
    chatGPTResp.append(newQueryContainer);
    resizeChatBox();

    loadingDots.show();
    arrowSend.hide();

    $.post("index.jsp?mode=chat&module=lesson&module_id={{module_id}}", { content : chatGPTQuestion.val(), parent_id : parent_id }, function(ret) {
        let content = "";
        if(ret.error === 0) {
            content = ret.data.content;
            parent_id = ret.data.id;
        } else {
            content = ret.message;
        }

        if(content === undefined) {
            content = ret.data.message;
        }

        chatGPTResp.value = content;
        const newAnswerContainer = document.createElement("div");
        newAnswerContainer.className = "answerContainer";
        const newParagraph = document.createElement("p");
        newParagraph.className = "answer";
        newParagraph.innerHTML = content;
        newAnswerContainer.appendChild(newParagraph);

        chatGPTResp.append(newAnswerContainer);
        resizeChatBox();

        loadingDots.hide();
        arrowSend.show();
        isQuery = false;
    }, 'json');

    chatGPTQuestion.val("");
}
</script>
</body>
</html>